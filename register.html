<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Register - VetConnect</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="topbar">
    <h1>VetConnect</h1>
    <nav>
      <a href="index.html">Home</a>
      <span id="nav-auth"></span>
    </nav>
  </div>

  <div class="container">
    <div class="card" style="max-width:600px;margin:0 auto;">
      <h2>Create Account</h2>
      <form id="registerForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="firstName" placeholder="First name" required />
          <input id="lastName" placeholder="Last name" required />
        </div>
        <input id="village" placeholder="Village" />
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="tehsil" placeholder="Tehsil" />
          <input id="district" placeholder="District" />
        </div>
        <input id="state" placeholder="State" />
        <input id="mobile" placeholder="Mobile number" />
        <input id="email" type="email" placeholder="Email" required />
        <input id="password" type="password" placeholder="Password" required />
        
        <select id="role">
          <option value="Farmer">Farmer</option>
          <option value="Doctor">Doctor</option>
        </select>

        <div id="doctorExtra" style="display:none">
          <input id="specialization" placeholder="Specialization" />
          <div style="display:flex;gap:8px">
            <input id="feesTeleconsult" type="number" placeholder="Online fee (₹)" />
            <input id="feesVisit" type="number" placeholder="Visit fee (₹)" />
          </div>
        </div>

        <button type="submit">Register</button>
      </form>
      <p id="error" style="color:red;margin-top:8px;"></p>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { API_BASE } from "./config.js";
    import "./navbar.js";

    const form = document.getElementById("registerForm");
    const roleSelect = document.getElementById("role");
    const doctorExtra = document.getElementById("doctorExtra");
    const errorEl = document.getElementById("error");

    // Toggle doctor fields
    roleSelect.addEventListener("change", () => {
      doctorExtra.style.display = roleSelect.value === "Doctor" ? "block" : "none";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const body = {
        firstName: document.getElementById("firstName").value,
        lastName: document.getElementById("lastName").value,
        village: document.getElementById("village").value,
        tehsil: document.getElementById("tehsil").value,
        district: document.getElementById("district").value,
        state: document.getElementById("state").value,
        mobile: document.getElementById("mobile").value,
        email: document.getElementById("email").value,
        password: document.getElementById("password").value,
        role: roleSelect.value,
      };

      if (roleSelect.value === "Doctor") {
        body.specialization = document.getElementById("specialization").value;
        body.feesTeleconsult = document.getElementById("feesTeleconsult").value;
        body.feesVisit = document.getElementById("feesVisit").value;
      }

      try {
        const res = await fetch(`${API_BASE}/auth/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();

        if (!res.ok) {
          if (data.message && data.message.includes("exists")) {
            errorEl.textContent = "This email ID already exists. Try to log in.";
          } else {
            errorEl.textContent = data.message || "Registration failed.";
          }
          return;
        }

        // Save session
        localStorage.setItem("token", data.token);
        localStorage.setItem("user", JSON.stringify(data.user));

        // Redirect
        window.location.href = "index.html";
      } catch (err) {
        errorEl.textContent = "Server error. Try again later.";
      }
    });
  </script>
</body>
</html>
